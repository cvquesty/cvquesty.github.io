
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Questy.org</title>
  <meta name="author" content="Jerald Sheets">

  
  <meta name="description" content="Picking Up Where I Left Off Sometimes life starts to get in the way of things. It happened to me. I&rsquo;m no longer consulting in the Puppet space &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://questy.org/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Questy.org" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1135877-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >

  <header role="banner"><hgroup>
  <h1><a href="/">Questy.org</a></h1>
  
    <h2>Tech musings and other things...</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="questy.org">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/10/02/some-housecleaning/">Some Housecleaning</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-10-02T09:23:38-04:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2018</span></span> <span class='time'>9:23 am</span></time>
        
           | <a href="/blog/2018/10/02/some-housecleaning/#disqus_thread"
             data-disqus-identifier="http://questy.org/blog/2018/10/02/some-housecleaning/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>Picking Up Where I Left Off</strong></p>

<p>Sometimes life starts to get in the way of things.  It happened to me. I&rsquo;m no longer consulting in the Puppet space, but am still very much so involved and active in the community. But, as happenstance dictates, we get busy in our daily and things like blogs (that don&rsquo;t generate revenue) and social media outlets start to take a &ldquo;second seat&rdquo; to the rest of work and life.</p>

<p>So, I&rsquo;m going to reset, and will be cycling back through the previous instructional materials I&rsquo;ve worked on, and revamp for modern editions my tutorials on PE, Community, Vagrant, etc. I want to stay up with modern versions, and I want to get deeper into PE and the new pe.conf (HOCON format) as well as better orchestration methods within the Vagrant framework for standing up new PE instances for use as a local development workstation (regardless of your platform).</p>

<p>Stick with me. We should have some fun changes here soon with all the new goodies Puppet has brought us over the last couple years.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/04/28/scaling-puppet-enterprise-part-vi-code-manager/">Scaling Puppet Enterprise - Part VI - Code Manager</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-04-28T11:48:13-07:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>11:48 am</span></time>
        
           | <a href="/blog/2017/04/28/scaling-puppet-enterprise-part-vi-code-manager/#disqus_thread"
             data-disqus-identifier="http://questy.org/blog/2017/04/28/scaling-puppet-enterprise-part-vi-code-manager/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Recap</h3>

<p>Let&rsquo;s see where we are.</p>

<ol>
<li>We have a Puppet Enterprise Split Installation consisting of a Puppet Master, PuppetDB, and Puppet Enterprise Console.</li>
<li>We have a Load Balancer with two compiler nodes behind it.</li>
<li>We have an ActiveMQ Hub and an ActiveMQ Spoke and have removed ActiveMQ responsibilites from the Enterprise Master (MoM).</li>
<li>We have built a GitLab instance to host our Control Repo and other items necessary to operation of our Puppet environment.</li>
</ol>


<hr />

<p>The final remaining piece is like a &ldquo;glue&rdquo; step where we pull all the various pieces together, generate keys for SSH and deployment tokens. We also associate the ctalog compilers to the Enterprise master and coordinate the deployment of code across the masters.  Needless to say, you will need to have already performed all the preceding steps, and have made everything ready to go for the following procedure. Failure to have done so will have unpredictable results. So, if you&rsquo;re ready, let&rsquo;s proceed.</p>

<h3>Setup A Control Repository</h3>

<p>The first and foremost piece is to have a repo whose job is to &ldquo;control&rdquo; the processig of modules and custom code, and giving the &ldquo;map&rdquo; for deployment into your Enterprise master and catalog compilers. Puppet Labs has a suggested sample one <a href="https://github.com/puppetlabs/control-repo">here</a> which has quite a number of nice features. However, when I first wrote this tutorial, it was considerably overkill for what I was needing to do, so I opted to create my own <strong>very simple</strong> version of a control repository. Quite a few iterations have occurred since writing these instructions, so I will continue with my instructions.</p>

<h3>The Control Repo</h3>

<p>The control repo came about as a collaboration at Puppet Labs between employees, consultants, users, etc. It was originally named something else which escapes me at the moment, but eventually came to be named the &ldquo;control repo&rdquo; by virtue of the service it performs. In short, it contains the &ldquo;map&rdquo; between what you have in Git or at the Puppet Forge, and the deployment directories on your Puppet masters. The &ldquo;map&rdquo; itself is known as the &ldquo;Puppetfile&rdquo;. This file contains a listing of all the modules you want deployed to the server. The bonus is that for each Git branch you have within the repo, this specifies an &ldquo;environment&rdquo; to Puppet.</p>

<p>I won&rsquo;t get into all the conversation around whether you should have 1:1 mapping between Git branches and Puppet Environments and then from Puppet Environments to application tiers&hellip; I&rsquo;ll leave that to the Puppet folks. I have always mapped everthing identically all the way through, and will cover that process here.</p>

<p><em>NOTE: The understood way of doing this these days is that if you have a new &ldquo;thing&rdquo; you want to create, you fork a feature branch, apply it to a few nodes for testing, then merge back into your master or production branch and deploy everywhere. I&rsquo;d recommend learning this. In my own needs, I had a lot of governed environments (PCI, SOX, ITIL, etc) that needed absolute code separation, and the ability to demonstrate that no code in one environment had a chance of deploying to another.  (principle of environment separation)  As a result, I always opted for 1:1 correlation.</em></p>

<p>I have created a sample control_repo you can clone from here:  <a href="https://github.com/cvquesty/control_repo.git">https://github.com/cvquesty/control_repo.git</a></p>

<p>This is a bare repo with a collection of Forge modules populated into the Puppetfile with a &ldquo;development&rdquo; and a &ldquo;production&rdquo; branch. This will trigger Puppet to create directories called &ldquo;development&rdquo; and &ldquo;production&rdquo; in /etc/puppetlabs/code/environments, and will contain the items you instruct it to deploy there from the Puppetfile.</p>

<p>First, clone the repo:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone https://github.com/cvquesty/control_repo.git</span></code></pre></td></tr></table></div></figure>


<p>to a working directory of your choice on your local node.  Next, change to the directory and view the remote:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd control_repo
</span><span class='line'>git remote -v</span></code></pre></td></tr></table></div></figure>


<p>This should present you with the GitHub location of my sample repo:</p>

<blockquote><p>origin    <a href="https://github.com/cvquesty/control_repo.git">https://github.com/cvquesty/control_repo.git</a> (fetch)
origin    <a href="https://github.com/cvquesty/control_repo.git">https://github.com/cvquesty/control_repo.git</a> (push)</p></blockquote>

<p>This will present you an issue in that you can&rsquo;t push to my repo. What I always tell people to do is to move it to their own Git repo. This is well documented elsewhere, but I&rsquo;ll give you an example process.</p>

<p>While in the control_repo directory, perform the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git checkout development
</span><span class='line'>git remote rm origin </span></code></pre></td></tr></table></div></figure>


<p>This now makes sure you&rsquo;re in the development branch, and that the repo is unattached to my GitHub account.  Next, you&rsquo;ll need to create a control_repo in <em>your</em> Git server, and set it as your own remote.  First login to your Git server and create an empty repo to hold the code. Next, in the repo you forked from mine, run the commands to switch repos like so:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git remote add origin https://&lt;YOUR_GIT_SERVER&gt;/&lt;YOUR_ID&gt;/control_repo.git
</span><span class='line'>
</span><span class='line'>git add .
</span><span class='line'>
</span><span class='line'>git commit -a -m 'Initial Commit'
</span><span class='line'>
</span><span class='line'>git push origin development
</span><span class='line'>
</span><span class='line'>git checkout production
</span><span class='line'>
</span><span class='line'>git add .
</span><span class='line'>
</span><span class='line'>git commit -a -m 'Initial Commit'
</span><span class='line'>
</span><span class='line'>git push origin production</span></code></pre></td></tr></table></div></figure>


<p>Now, you have the repo local to you and pointing to your own Git repository so you can edit and update the control_repo at will.  <em>(you might note extra steps there.  This is for those unfamiliar with Git.  They may not be necessary, but it gives a good pattern for how to work with repos, and I want to establish good habits early.)</em></p>

<h3>Generate SSH Keys</h3>

<p>On the Enterprise Master, you will need to create locations and/or set permissions on files and directories used by Code Manager:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chown -R pe-puppet:pe-puppet /etc/puppetlabs/code
</span><span class='line'>chown -R pe-puppet:pe-puppet /etc/puppetlabs/code-staging
</span><span class='line'>mkdir -p /etc/puppetlabs/puppetserver/ssh</span></code></pre></td></tr></table></div></figure>


<p>Next, you will need to generate a secret key to use with Code Manager setup.  To create the secret key, perform the following on the Enterprise Master:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ssh-keygen -t rsa -b 4096 -C "SSH Deploy Keys"</span></code></pre></td></tr></table></div></figure>


<p>When ssh-keygen asks you what to name the key, I usually give it a name I can remember, name it after the customer I am doing work for, or just name it for the Control Repo itself. In this case, let&rsquo;s answer with the latter:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/puppetlabs/puppetserver/ssh/id-control_repo.rsa</span></code></pre></td></tr></table></div></figure>


<p>Now, when configuring Code Manager in the Puppet Enterprise Console, you will use that key.</p>

<p>next, ensure all associated files are owned by the PE user:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chown -R pe-puppet:pe-puppet /etc/puppetlabs/puppetserver/ssh</span></code></pre></td></tr></table></div></figure>


<h3>Create RBAC Code Manager User</h3>

<p>Next, you&rsquo;ll need a Code Manager user in the Enterprise Console. use the following process for that:</p>

<ol>
<li>Create a new role named &ldquo;Deploy Environments&rdquo;</li>
<li><p>Assign this role the following permissions:</p>

<ul>
<li>Add the &ldquo;<strong>Puppet Environment</strong>&rdquo; type.</li>
<li>Set <strong>Permissions</strong> for this type to &ldquo;<strong>Deploy Code</strong>&rdquo;</li>
<li>Set the <strong>Object</strong> for this type to <strong>All</strong>.</li>
</ul>
</li>
<li><p>Add the <strong>Tokens</strong> Type</p>

<ul>
<li>Set <strong>Permissions</strong> for this type to <strong>Override Default Expiry.</strong></li>
</ul>
</li>
<li>Create a local user to manage code deployments.

<ul>
<li>Click &ldquo;<strong>Access Control | users</strong>&rdquo;</li>
<li>On the <strong>Users</strong> page, in the <strong>Full Name</strong> field, type the User&rsquo;s Full Name: (e.g. <strong>CM Admin</strong>)</li>
<li>In the <strong>Login</strong> field, type the name <strong>cmadmin</strong>.</li>
<li>Click <strong>Add Local User</strong>.</li>
</ul>
</li>
<li>Set the User&rsquo;s password to &ldquo;puppetlabs&rdquo; (or whatever you&rsquo;d like to use)

<ul>
<li>Select the user from the list.</li>
<li>Click &ldquo;<strong>Generate password reset</strong>&rdquo;</li>
<li>Retrieve the link in a browser, and set the password to &ldquo;<strong>puppetlabs</strong>&rdquo;.</li>
</ul>
</li>
<li>Finally, add the user to the &ldquo;<strong>Deploy Code</strong>&rdquo; role.

<ul>
<li>Click the &ldquo;<strong>Deploy Environments</strong>&rdquo; role.</li>
<li>Click the &ldquo;<strong>Member Users</strong>&rdquo; tab.</li>
<li>Fromt the dropdown list in the <strong>User Name</strong> field, select the <strong>CM Admin</strong> user and click <strong>Add User</strong>.</li>
</ul>
</li>
</ol>


<h3>Code Manager</h3>

<p>Under the covers, Puppet Labs now uses r10k with the control repository to manage the deployment of code.nUnder this scenario, a few items are very important to remember:</p>

<ul>
<li>Under no circumstances should you be manually editing code in /etc/puppetlabs/code any more. Any attempt to do so will be overwritten by the code manager. ALL deployments to the system must come through your editing the control_repo and pointing to either Forge modules or custom modules you have written to be deployed to your Enterprise Master (and sync'ed to the catalog compilers).</li>
<li>You <strong>must</strong> have a control repo branch for each environment you wish to represent in your Masters (production, testing, etc.)</li>
<li>You cannot shorten or live without the fully named &ldquo;production&rdquo; environment. Puppet hard-coded this environment name in the product, and shortening the name to &ldquo;prd&rdquo;, &ldquo;prod&rdquo;, etc. will not work.</li>
<li>Code Manager operates with a synchronization subdirectory that lives in /etc/puppetlabs/code-staging. When you&rsquo;re pushing coe via your control_repo, it goes here first, then Code Manager and Code Sync take over, and publish the code to all compile masters at once. Once all masters have the code in code-staging, it gets copied to /etc/puppetlabs/code.</li>
</ul>


<p>More information on this process can be found at <a href="https://docs.puppet.com/pe/2015.3/code_mgr.html">Puppet&rsquo;s Documentation site</a>.</p>

<h3>Configuring the Git Server</h3>

<p>You should have a custom deployment user explicitly for pushing code into your master. I have settled on using &ldquo;cmadmin&rdquo; as a deploy user on the Git Server. This allows you to have a generic user on the GitLab server you created earlier that you can work with, configure web hooks for, and then leave the credentials for that user with your customer or place it into IDM for your company.</p>

<p>To setup the new user:</p>

<ol>
<li>Create a user in the admin area of the GitLab server named &ldquo;<strong>cmadmin</strong>&rdquo;.  Next, select &ldquo;<strong>Edit</strong>&rdquo; in the upper right hand corner of the screen and set the password as you see fit. <em>(I&rsquo;ll use &ldquo;<strong>puppetlabs</strong>&rdquo;)</em></li>
<li>Select &ldquo;Impersonate&rdquo; from the upper right hand section of the page to assume the identity of the &ldquo;<strong>cmadmin</strong>&rdquo; user.</li>
<li>Select &ldquo;<strong>New Project</strong>&rdquo;.</li>
<li>On the resulting page, create a new repo called &ldquo;<strong>control_repo</strong>&rdquo; and make it a piblic project.</li>
<li>Click &ldquo;<strong>Create Project</strong>&rdquo;.</li>
<li>Push the control repo from the previous section to this repo in the <strong>cmadmin</strong> space.</li>
<li>Seeing as we are using GitLab, you are unable to use a full authenticated deploy token because GitLab server&rsquo;s input buffer is too short to handle a full authentication token. <em>NOTE: This has changed in later versions of GitLab. You may find success in just creating the token.</em></li>
<li><p>Configure the Webhook:</p></li>
<li><p>Connect to your Git server <em>(e.g. <a href="http://git.example.com">http://git.example.com</a>)</em> and choose the &ldquo;<strong>settings gear</strong>&rdquo; from the bottom left hand side of the page.</p></li>
<li>Once in the settings for the <strong>cmadmin</strong> user, there is a small icon on the left frame tht looks like two links of chain and is labelled &ldquo;<strong>Webhooks</strong>&rdquo;.</li>
<li>Next, add the _<strong><a href="https://master.example.com:8170/code-manager/v1/webhook?type=gitlab**_">https://master.example.com:8170/code-manager/v1/webhook?type=gitlab**_</a> formatted webhook into the &ldquo;</strong>URL**&rdquo; box.</li>
</ol>


<p><em>The &ldquo;<strong>prefix</strong>&rdquo; section points to the name od the user based on the way GitLab uses namespaces in the URL.</em></p>

<ul>
<li>Also select items you need from the list of options. I recommend selecting all items <strong>except</strong> &ldquo;<strong>Build Events</strong>&rdquo; and <strong>DE</strong>-select &ldquo;<strong>Enable SSL Verification</strong>&rdquo;.</li>
<li>Click &ldquo;<strong>Add Webhook</strong>&rdquo;.</li>
</ul>


<h3>Configuring the SSH Key</h3>

<p>Finally, add the <strong>PUBLIC</strong> SSH key created on the Enterprise master located at /etc/puppetlabs/puppetserver/ssh/id-control_repo.rsa.pub to the SSH keys section for the <strong>CM Admin</strong> user in the GitLab Server.</p>

<ol>
<li>While still impersonating the &ldquo;<strong>cmadmin</strong>&rdquo; user in the GitLab GUI Interface, choose the &ldquo;<strong>cmadmin</strong>&rdquo; icon in the lower left of the browser.  Next, choose &ldquo;<strong>Profile Settings</strong>&rdquo; in the left hand bar.</li>
<li>Under the profile&rsquo;s Settings, choose &ldquo;<strong>SSH Keys</strong>&rdquo; from the left hand bar.</li>
<li>Paste in the <strong>PUBLIC KEY</strong> to the &ldquo;<strong>Key</strong>&rdquo; text box. The <strong>Title</strong> text box should populate automatically. <em>(or, you can name it yourself.)</em></li>
<li>Click &ldquo;<strong>Add Key</strong>&rdquo;.</li>
</ol>


<h3>Installing Code Manager</h3>

<p>This process assumes you have follwed this entire series from start to here in order. The final steps are to install and configure the Code Manager itself. This is that process.</p>

<ol>
<li>At the <strong>Puppet Enterprise Console</strong>, navigate to <strong>Nodes | Classification | PE Master | Classes Tab | puppet_enterprise::profile::master</strong>.</li>
<li><p>In the <strong>puppet_enterprise::profile::master</strong> class, you need to set the following parameters:</p></li>
<li><p><strong>r10k_remote</strong> => &lsquo;the <em>git</em> FQDN and path to the namespace/control_repo of this node.&rsquo;</p></li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>e.g. **git@git.example.com:cmadmin/control_repo.git**</span></code></pre></td></tr></table></div></figure>


<ul>
<li><strong>r10k_private_key</strong> => &lsquo;the full path to your deploy key on your Puppet enterprise master&rsquo;</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>e.g. **/etc/puppetlabs/puppetserver/ssh/id-control_repo.rsa**</span></code></pre></td></tr></table></div></figure>


<ul>
<li><strong>file_sync_enabled</strong> => true</li>
<li><strong>code_manager_auto_configure</strong> => true</li>
</ul>


<p>At this point, you also want to make sure your control_repo has a hieradata value set. If you cloned your repo from mine, you already have that value set in the common.yaml in the hieradata directory. That setting would be:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>puppet_enterprise::master::code_manager::authenticate_webhook: false</span></code></pre></td></tr></table></div></figure>


<p><em>NOTE: Recall that GitLab has change dramatically since the original writing of this tutorial. Later versions allow you to authenticate the webhook. WHen I wrote this, I was working around technological limitations that are now gone. Feel free to complete this as needed, but I just wanted to disclaim the reasoning for these previous configuration steps.</em></p>

<p>Next, ensure the hiera.yaml lives in $confdir as needed for Code manager:</p>

<ul>
<li>Edit the /etc/puppetlabs/puppet/puppet.conf file to ensure there is a line in the &ldquo;<strong>[Main]</strong>&rdquo; section: <strong>hiera_config = $confdir/hiera.yaml</strong>.</li>
</ul>


<p>Finally, run the puppet agent to apply all the above configuration changes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>puppet agent -t</span></code></pre></td></tr></table></div></figure>


<p>Test the hiera value on the command line to ensure Hiera has picked up your value:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>hiera -c /etc/puppetlabs/puppet/hiera.yaml puppet_enterprise::master::code_manager::authenticate_webhook environment=production</span></code></pre></td></tr></table></div></figure>


<p>You should get a return of &ldquo;false&rdquo;.</p>

<p><em>NOTE: Later versions of Hiera respond to the &ldquo;lookup&rdquo; command. The older &ldquo;hiera&rdquo; command line utility has intermittent proper functioning at this time, and it has been recommended on the Puppet Community Slack that &ldquo;Lookup&rdquo; is the way to go at this time.</em></p>

<h3>Generate Authentication Token</h3>

<p>On the Puppet Enterprise Master, you must now generate an authentication token for the CM Admin deployment user to be authorized to push code.  First, request the token:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/opt/puppetlabs/bin/puppet-access login --service-url https://console.example.com:4433/rbac-api --lifetime 180d</span></code></pre></td></tr></table></div></figure>


<p>It will request a username and password. Use the credentials you created in the RBAC console <em>(In my example, <strong>cmadmin::puppetlabs</strong>)</em> and the system will write the token to <strong>/root/.puppetlabs/token</strong>.</p>

<h3>Time to restart!!</h3>

<p>Run the puppet agent on all compile masters in no particular order:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>**puppet agent -t**</span></code></pre></td></tr></table></div></figure>


<h3>Now, lets' Test!!</h3>

<p>Prior to PE 2016.x.x, you could only fire the tests with curl commands against the API. Those would be as follows:</p>

<p><strong>Deploy a Single Environment</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/bin/curl -k -X POST -H 'Content-Type: application/json' "https://localhost:8170/code-manager/v1/deploys? token=`cat ~/.puppetlabs/token`" -d '{"environments": ["ENVIRONMENTNAME"], "wait": true}'</span></code></pre></td></tr></table></div></figure>


<p><strong>Deploy All Code Manager Managed Environments</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/bin/curl -k -X POST -H 'Content-Type: application/json' "https://localhost:8170/code-manager/v1/deploys?token=`cat ~/.puppetlabs/token`" -d '{"deploy-all": true}'</span></code></pre></td></tr></table></div></figure>


<p>On PE Versions 2016.x.x and later, a new tool known as puppet-code was created to ease the testing and firing of the deploys.</p>

<p><strong>Deploy a Single Environment</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/opt/puppetlabs/bin/puppet-code deploy {environmentname}</span></code></pre></td></tr></table></div></figure>


<p><strong>Deploy All Code Manager Managed Environments</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/opt/puppetlabs/bin/puppet-code deploy --all</span></code></pre></td></tr></table></div></figure>


<h3>Conclusion</h3>

<p>At this point, you should see your code beginning to populate the <strong>/etc/puppetlabs/code-staging</strong> directory and then eventually the <strong>/etc/puppetlabs/code</strong> directory.  Your final tests will include pushing code to the control_repo to test that the hook is working properly.</p>

<p>If all goes well, you should have code automatically deploy to the $codedir after a few seconds to a minute depending on a variety of factors.</p>

<h4>Other Stuff</h4>

<p>I wrote these as tutorials as I mentioned in the first article to help coworkers complete the same process I was doing. I had to sanitize out a lot of internal info, and I had to change hostnames on the fly to make sure &ldquo;all the things&rdquo; were secret that needed to be, so the names in question have not been specifically tested end-to-end, but the principles are the same.</p>

<p>I worked on both 2015.x.x and 2016.x.x with this process, but newer versions of PE may have different features or setup options not covered here.  As with any &ldquo;Open&rdquo; documentation, &ldquo;Your mileage may vary&rdquo; and &ldquo;Use at your own risk.&rdquo;</p>

<p>I hope this helps someone out there get Code Manager setup and fuctioning in a Large Environment Installation scenario, and you scale as large as you need to as a result of the footwork I&rsquo;ve done here. Feel free to email me for errors you find, and I&rsquo;ll fix &lsquo;em up right away!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/04/24/scaling-puppet-enterprise-part-v-gitlab/">Scaling Puppet Enterprise - Part v - GitLab</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-04-24T21:48:29-07:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>9:48 pm</span></time>
        
           | <a href="/blog/2017/04/24/scaling-puppet-enterprise-part-v-gitlab/#disqus_thread"
             data-disqus-identifier="http://questy.org/blog/2017/04/24/scaling-puppet-enterprise-part-v-gitlab/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you&rsquo;ve been following for the past 5 installments, we&rsquo;re nearing the end! Note that each of the prior articles required other things to have been completed before reading/performing the contained steps, but this article is a bit different. In all truth, you could do this process at any point, but I placed it here for one reason alone. <em>&ldquo;Why do this manually when I could get Puppet to do it for me?&rdquo;</em></p>

<p>The importance of this particular step is that we need a place to hold our &ldquo;control repo&rdquo; <em>(more on this later)</em> and if you don&rsquo;t already have Git installed in your environment, you&rsquo;ll need it. So, before finishing up the installation and configuration of Code Manager, utilizing Puppet to install GitLab is a good test that everything is installed and configured properly, and all the components are communicating as expected.</p>

<p>Without further delay, let&rsquo;s continue.</p>

<hr />

<h3>Create a Machine to Serve as the GitLab Server</h3>

<p>Provision a new node according to our earlier chart to serve as your GitLab server. While I list specifications, you may find more mileage by scaling the Git server larger. If you will be expanding your Puppet team and will have dozens to hundreds of people developing for Puppet, scaling will be a consideration. Also, while outside the scope of this article, you will want to configure offsite backup and/or replication to a geographically separte location for your GitLab server. This is of paramount importance. If you lose this server, all configuration for all systems managed in all environments across your organization would be lost. This isn&rsquo;t the end of the world in terms of business continuity, but trying to recreate all that code from the ground up would be prohibitive.</p>

<p>Yes, people will have recent copies of the repo on their local machines. Yes, with some nonzero level of effort, you should be able to get the repos back.  No, it&rsquo;s not fun, and you&rsquo;ll have a bad time. Just back up your server, and if possible&hellip;replicate it elsewhere in your organization.</p>

<p>My intial suggested specifications on this server are:</p>

<p><img src="http://cvquesty.github.io/images/gitlab_specs.png" alt="GitLab Specs" /></p>

<p>I don&rsquo;t specify disk for /opt and /var here, as each of these images carries ample disk with it. If you believe you will need additional storage for your Git instance, feel free to scale this as you see fit.</p>

<p>Once the server is installed, go ahead and install the Puppet Agent on it, pointing to the compiler VIP like so:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -k https://compile.example.com:8140/packages/current/install.bash | bash</span></code></pre></td></tr></table></div></figure>


<p>Once the agent installation is complete, in the Puppet Enterprise Console, navigate to <strong>Nodes | Unsigned Certificates</strong> and accept the new cert request for the GitLab server. Once that is complete, SSH to the GitLab server, and run <strong>puppet agent -t</strong> to complete the initial configuration of the node.</p>

<h3>Create a Profile to Manage the GitLab Installation</h3>

<p>On the Puppet Enterprise Master, install the <strong>vshn-gitlab</strong> module.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>puppet module install vshn-gitlab</span></code></pre></td></tr></table></div></figure>


<p><strong>NOTE: You will need to perform this on ALL catalog compilers in your infrastructure. If the GitLab serer checks in and doesn&rsquo;t find either the vshn-gitlab module or the profile you&rsquo;re creating below on the master the load balancer refers it to, the catalog run will fail.</strong></p>

<p>On the Puppet Enterprise Master <em>(eg. master.example.com)</em> create a new profile in <strong>$codedir/environments/production/modules/profiles/manifests/gitlab.pp</strong>.</p>

<p><em>(Puppet Enterprise has an internal variable for $codedir now. If you have made no modifications to this in the puppet.conf, the default location is /etc/puppetlabs/code.)</em></p>

<p>The profile you create should look like the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Configure GitLab Server
</span><span class='line'>class profiles::gitlab {
</span><span class='line'>
</span><span class='line'>  class { 'gitlab':
</span><span class='line'>    external_url =&gt; 'http://git.example.com',
</span><span class='line'>  }
</span><span class='line'>  
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Save this as gitlab.pp.</p>

<p>In the Puppet Enterprise Console, create a new classification group.</p>

<ul>
<li>Navigate to <strong>Nodes | Classification</strong></li>
<li>Create a group called &lsquo;<strong>GitLab</strong>&rsquo; with a parent of &lsquo;<strong>All Nodes</strong>&rsquo; in the Production Environment</li>
<li>Pin the <strong>git.example.com</strong> node into the newly created <strong>GitLab</strong> group.</li>
<li>Choose the &lsquo;<strong>Classes</strong>&rsquo; tab and click the &lsquo;<strong>Refresh</strong>&rsquo; icon to pick up your newly created profile.</li>
<li>Add the <strong>profiles::gitlab</strong> class to the classification group.</li>
<li>Commit the changes.</li>
</ul>


<h3>Caveats</h3>

<p>Since we&rsquo;re mid-setup and have multiple compilers but do <strong>not</strong> have code sync enabled, we have to manually copy the new profile to all your compilers in the same location. This allows the agent on the GitLab server to pick up the profile regardless of where the load balancer sends the agent request.</p>

<p>Once the profile is in place, run <strong>puppet agent -t</strong> on your GitLab server, and Puppet will then install the GitLab software onto the server. At this point, after a short delay, you should be able to retrieve your GitLab server in a browser <em>(e.g. <a href="http://git.example.com">http://git.example.com</a>)</em> and login with the default credentials.</p>

<p>In our example, <strong>git.example.com</strong> is the server and the login would be automatically set to <strong>admin@example.com</strong> with a password of <strong>5iveL!fe</strong>.  These are defaults set by the GitLab installer.</p>

<p>Your GitLab server should now be up, running, and ready for action in your Puppet Environment.  Look for the final installment to bring everything together and finish the installation.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/04/24/scaling-puppet-enterprise-part-iv-activemq-hub-and-spokes/">Scaling Puppet Enterprise - Part IV - ActiveMQ Hub and Spokes</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-04-24T21:10:52-07:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>9:10 pm</span></time>
        
           | <a href="/blog/2017/04/24/scaling-puppet-enterprise-part-iv-activemq-hub-and-spokes/#disqus_thread"
             data-disqus-identifier="http://questy.org/blog/2017/04/24/scaling-puppet-enterprise-part-iv-activemq-hub-and-spokes/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong><em>As in the previous installment, you need to have already completed a few steps before arriving at this post.  You should have already completed a &ldquo;split installation&rdquo; (Documented <a href="http://questy.org/blog/2017/04/18/scaling-puppet-enterprise-part-ii-installation/">here</a>). Also, your load balancer needs to be configured and running. The procedure for this portion can be found <a href="http://questy.org/blog/2017/04/21/scaling-puppet-enterprise-part-iii-additional-compilers-part-1/">here</a>.  Finally, you should have the additional compilers installed and configured along with two example agent nodes as covered <a href="http://questy.org/blog/2017/04/21/scaling-puppet-enterprise-part-iiia-additional-compilers/">here</a> and <a href="http://questy.org/blog/2017/04/21/scaling-puppet-enterprise-part-iiib-additional-compilers/">here</a>.. If you&rsquo;ve completed all these portions, you are now ready to configure ActiveMQ for scaling MCollective.</em></strong></p>

<p>Once the preceding items are performed, you may find it necessary to add ActiveMQ hubs and spokes to increase capacity for MCollective and/or the Code Sync and Code Manager functions of Puppet Enterprise. This installment documents how to install these additional components and tie them into the existing infrastructure.</p>

<h3>Create an ActiveMQ Hub</h3>

<ol>
<li>Go to the Puppet Enterprise Console in your browser.</li>
<li>Select <strong>Nodes | Classification</strong> and create a new group called <strong>&ldquo;PE ActiveMQ Hub&rdquo;</strong></li>
<li>Stand up two new nodes for the ActiveMQ Hub and Spoke (in our example, <strong>activemq-hub.example.com</strong> and <strong>activemq-spoke.example.com</strong>) according to the following specifications:</li>
</ol>


<p><img src="http://cvquesty.github.io/images/hub_spoke_specs.png" alt="Hub and Spoke Specs" /></p>

<p>Once your nodes have been provisioned, install the Puppet Agent on each node, <strong>making sure to point the installer DIRECTLY at the MoM (</strong>master.example.com**) instead of at the compiler VIP.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -k https://master.example.com:8140/packages/current/install.bash | bash</span></code></pre></td></tr></table></div></figure>


<p>
and let the agent install complete in its entirety.</p>

<p>Next, from your browser, retrieve the Puppet Enterprise Console and select the &ldquo;<strong>PE ActiveMQ Hub</strong>&rdquo; group you created earlier. Pin the <strong>activemq-hub.example.com</strong> node into the <strong>PE ActiveMQ Hub</strong> group.</p>

<ol>
<li>Select the &ldquo;<strong>Classes</strong>&rdquo; tab and add a new class entitled: &ldquo;<strong>puppet_enterprise::profile::amq::hub</strong>&rdquo;</li>
<li>Click &ldquo;<strong>Add Class</strong>&rdquo;.</li>
<li>Under the Parameters drop-down, select &ldquo;<strong>network_collector_spoke_collect_tag</strong>&rdquo; and set its value to &ldquo;<strong>pe-amq-network-connectors-for-activemq-hub.example.com</strong>&rdquo;</li>
<li>Commit the changes.</li>
<li>SSH to the <strong>activemq-hub.example.com</strong> and run <strong>puppet agent -t</strong> to make all your changes effective for the Hub node.</li>
</ol>


<h3>Create ActiveMQ Spoke (or &ldquo;broker&rdquo;)</h3>

<ol>
<li>In the Puppet Enterprise Console, Select <strong>Nodes | Classification | PE ActiveMQ Broker</strong></li>
<li>Pin your new ActiveMQ broker into the <strong>PE ActiveMQ Broker</strong> group.</li>
<li>Select the &ldquo;<strong>Classes</strong>&rdquo; tab.</li>
<li>Under the <strong>puppet_enterprise::profile::amp::broker</strong> class, choose the <strong>activemq_hubname</strong> parameter and set it to the FQDN of the hub you just created. In our case, <strong>activemq-hub.example.com</strong>.</li>
<li>SSH to the new broker (<strong>activemq-spoke.example.com</strong>) and run <strong>puppet agent -t</strong>.</li>
<li>Finally, unpin <strong>master.example.com</strong> from the <strong>PE ActiveMQ Broker</strong> group.</li>
</ol>


<h3>Conclusion</h3>

<p>At this point, you should have:</p>

<ul>
<li>Puppet Master of Masters - <strong>master.example.com</strong></li>
<li>PuppetDB - <strong>puppetdb.example.com</strong></li>
<li>PE Console - <strong>console.example.com</strong></li>
<li>HAProxy Node - <strong>compiler.example.com</strong></li>
<li>2 Catalog compilers - <strong>compile1.example.com</strong> and <strong>compile2.example.com</strong></li>
<li>An ActiveMQ Hub - <strong>activemq-hub.example.com</strong></li>
<li>An ActiveMQ Spoke - <strong>activemq-spoke.example.com</strong></li>
<li>Two Agent Nodes - <strong>agent1.example.com</strong> and <strong>agent2.example.com</strong></li>
</ul>


<p>with their respective configurations. Your serving infrastructure is complete, and you are now ready to configure it for use.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/04/23/scaling-puppet-enterprise-part-iiib-additional-compilers/">Scaling Puppet Enterprise - Part IIIb - Additional Compilers</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-04-23T18:19:42-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2017</span></span> <span class='time'>6:19 pm</span></time>
        
           | <a href="/blog/2017/04/23/scaling-puppet-enterprise-part-iiib-additional-compilers/#disqus_thread"
             data-disqus-identifier="http://questy.org/blog/2017/04/23/scaling-puppet-enterprise-part-iiib-additional-compilers/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong><em>As in the previous installment, you need to have already completed a few steps before arriving at this post.  You should have already completed a &ldquo;split installation&rdquo; (Documented <a href="http://questy.org/blog/2017/04/18/scaling-puppet-enterprise-part-ii-installation/">here</a>). Also, your load balancer needs to be configured and running. The procedure for this portion can be found <a href="http://questy.org/blog/2017/04/21/scaling-puppet-enterprise-part-iii-additional-compilers-part-1/">here</a>.  If you&rsquo;ve completed all these portions, you are now ready to configure and install the compilers themselves. If this is you, read on!</em></strong></p>

<hr />

<p>Once your Load Balancer and split install are in place and functioning, we need to add more compilers to the serving infrastructure. For the purposes of this tutorial, we will install two additional catalog compilers, register them with the currently existing master. Then, we will direct them to look to the &ldquo;MoM&rdquo; or the &ldquo;Master of Masters&rdquo; as the CA certificate authority.  Further, we will install two agent nodes and connect them to the infrastructure.</p>

<p>You will need to install two compiler nodes and two agent nodes according to the following specifications.</p>

<p><img src="http://cvquesty.github.io/images/compiler_and_agent_specs.png" alt="Compilers and Agents" /></p>

<p>Once these four nodes are in place, we can connect the compilers to the Master of Masters (MoM) and then the agents to the &ldquo;master&rdquo; as they see it.  Remember, that for our purposes, these nodes are named:</p>

<ul>
<li>compile1.example.com</li>
<li>compile2.example.com</li>
<li>agent1.example.com</li>
<li>agent2.example.com</li>
</ul>


<h3>Installing the Compilers</h3>

<p>SSH to the first compiler master (<strong>compile1.example.com</strong> for this post&rsquo;s purposes) and install the Puppet agent as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -k https://master.example.com:8140/packages/current/install.bash | bash -s main:dns_alt_names=compile1.example.com,compile.example.com,compile1,compile</span></code></pre></td></tr></table></div></figure>


<p>What this does is simple. When this compiler goes behind the load balancer (<strong>compile.example.com</strong>), traffic may get directed to this node. When the request is made, the agent node will be asking for &ldquo;<strong>compile.example.com</strong>&rdquo; but this node&rsquo;s name is &ldquo;<strong>compile1.example.com</strong>&rdquo;. The additional options at the end of the curl line are to tell the agent that when it installs, it should be aware of both names, and when speaking to the MoM the first time to request its cert, to represent all the comma delimited names listed at the end of the above command.</p>

<p>Next, SSH to your master node and accept the agent cert request as follows to allow for these names on the MoM you just set up in the previous step.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ssh master.example.com
</span><span class='line'>puppet cert --allow-dns-alt-names sign compile1.example.com
</span></code></pre></td></tr></table></div></figure>


<h4>NOTE THAT YOU CANNOT ACCEPT THIS CERT FROM THE CONSOLE. ALT_DNS IS NOT SUPPORTED FROM THE GUI</h4>

<p>Finally, run the puppet agent on the first compiler <em>(compile1.example.com)</em> to configure the node:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>puppet agent -t</span></code></pre></td></tr></table></div></figure>


<p>Once the agent run is complete, you need to classify the catalog compiler in the console to make it ready for service.</p>

<h3>Classify the Compiler</h3>

<p>In the Puppet Enterprise Console:</p>

<p>Choose <strong>Nodes | Classification | PE Master</strong></p>

<p>Add <strong>compile1.example.com</strong> and pin the node to the classification group and commit the change.</p>

<p><strong><strong><em>BE SURE TO COMPLETE THE NEXT STEPS IN ORDER AS FOLLOWS OR YOU WILL HAVE A BAD TIME</em></strong></strong></p>

<p>First: SSH to <strong>compile1.example.com</strong> and run <strong><em>puppet agent -t</em></strong></p>

<p>Second: SSH to <strong>puppetdb.example.com</strong> and run <strong><em>puppet agent -t</em></strong></p>

<p>Third: SSH to <strong>console.example.com</strong> and run <strong><em>puppet agent -t</em></strong></p>

<p>Fourth: SSH to <strong>master.example.com</strong> and run <strong><em>puppet agent -t</em></strong></p>

<p><strong><strong><em>BE SURE TO ALLOW EACH RUN TO COMPLETE <em>FULLY</em> BEFORE MOVING ON TO THE NEXT ONE</em></strong></strong></p>

<h3>For All Subsequent Compile Node Installations</h3>

<p>Follow the above instructions completed for <strong>compile1.example.com</strong> for all subsequent compiler installations. This means that if you add compilers six months or a year from now, go back to the previous procedure and duplicate it with the new node name precisely as you did above.  To recap:</p>

<ol>
<li>Install the agent as above with the alt_dns switches</li>
<li>Accept the cert on the master with the alt_dns switches</li>
<li>Classify the compiler in the console</li>
<li>Run the Puppet agent in the above specified order, allowing each one to complete fully before moving on.</li>
</ol>


<h3>Configure Future Agent Installations to Point to the Load Balancer by Default</h3>

<p>In the Puppet Enterprise Console, you must configure the system to point all future agent installations to the load balancer by default so you do not have to continue to make modifications and customizations after each agent install. To do so, perform the following steps:</p>

<ol>
<li>In the Puppet Enterprise Console, choose: <strong>Nodes | Classification | PE Master</strong></li>
<li>Select the &ldquo;<strong>Classes</strong>&rdquo; tab.</li>
<li>Choose the &ldquo;<strong>pe_repo</strong>&rdquo; class.</li>
<li>Under the parameters drop-down, choose &ldquo;master&rdquo; and set the text box to the name of your load balancer or VIP <em>(in our case, <strong>&ldquo;compile.example.com&rdquo;</strong>)</em></li>
<li>Commit the changes.</li>
</ol>


<h3>Point the New Compilers at the Master (MoM) for CA Authority</h3>

<h4>Create a new classification group called &ldquo;PE CA pe_repo Override&rdquo;</h4>

<ul>
<li>Go to <strong>Nodes | Classification</strong> in the Puppet Enterprise Console</li>
<li>Create a New Group</li>
<li>Name the new group &ldquo;<strong>PE CA pe_repo Override</strong>&rdquo;</li>
<li>From the &ldquo;Parent Name&rdquo; drop-down, choose the &ldquo;<strong>PE Master</strong>&rdquo; group.</li>
<li><p>Click &ldquo;Add Group&rdquo;.</p></li>
<li><p>Select your new group and pin <strong>master.example.com</strong> to the new group and click &ldquo;<strong>Commit One Change</strong>&rdquo;</p></li>
<li>Select the &ldquo;<strong>Classes</strong>&rdquo; tab.</li>
<li>Add &ldquo;<strong>pe_repo</strong>&rdquo; class.</li>
<li>From the parameter drop-down, select &ldquo;<strong>Master</strong>&rdquo;.</li>
<li>Enter the name of the MoM in the text box. <em>(in this example, <strong>master.example.com</strong>)</em></li>
<li>Click &ldquo;Add Parameter&rdquo; and then &ldquo;Commit 2 Changes&rdquo;.</li>
</ul>


<h4>Test New Agents</h4>

<p>The two agents you created at the beginning of the article are now able to be tested with this new group of compilers.</p>

<ol>
<li>Make sure <strong>agent1.example.com</strong> and <strong>agent2.example.com</strong> have been installed according to the system requirements covered in this series.</li>
<li>Install the Puppet agent on each of these nodes, but this time instead of pointing at the MoM, point to your Load balancer vip like so:</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -k https://compile.example.com:8140/packages/current/install.bash | bash</span></code></pre></td></tr></table></div></figure>


<p>In the PE Console, accept the new certificate request for Agent1.  SSH to <strong>agent1.example.com</strong> and run <em><strong>puppet agent -t</strong></em>.  Finally, repeat this process for <strong>agent2.example.com</strong>.</p>

<p>If you have completed all the above steps properly, the agents will reach out to the <strong>compile.example.com</strong> VIP and be ferried off to one of the catalog compilers. Regardless of which one, since we accepted all the alternate DNS names when creating the connection between them and the MoM, they will respond for <strong>compile.example.com</strong>, and deliver back to the agent the required information, catalog, etc. as Puppet would do under normal circumstances.</p>

<h3>Conclusion</h3>

<p>As you can see, we needed the Load Balancer in place to install the catalog compilers. We also needed all the DNS alt-naming to be in place so the load balancer could send traffic to either catalog compiler as needed, and still have it answer for the VIP name. Finally, we needed to refer requests to their appropriate destinations and also classify the new compilers as such with the MoM, and set up appropriate referral of certificate requests from the compilers back to the CA Master, which is the MoM.</p>

<p>The serving infrstructure is almost done, all we have left to do is to scale MCollective with an ActiveMQ Hub &amp; Spoke, and remove that responsibility from the MoM.  We will also install a GitLab server to hold our Control Repo and associated Roles &amp; Profiles, and we will configure the Code Manager.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/04/21/scaling-puppet-enterprise-part-iiia-additional-compilers/">Scaling Puppet Enterprise - Part IIIa - Additional Compilers</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-04-21T09:32:47-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2017</span></span> <span class='time'>9:32 am</span></time>
        
           | <a href="/blog/2017/04/21/scaling-puppet-enterprise-part-iiia-additional-compilers/#disqus_thread"
             data-disqus-identifier="http://questy.org/blog/2017/04/21/scaling-puppet-enterprise-part-iiia-additional-compilers/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong><em>You should have completed a split install before beginning this section. You can find the Split Installation documentation at Puppet&rsquo;s Website, or the first installment of this tutorial <a href="http://questy.org/blog/2017/04/18/scaling-puppet-enterprise-part-ii-installation/">here</a>.  If you try and begin here, you might find yourself lost.</em></strong></p>

<p><strong><em>Note also that the &ldquo;Additional Compilers&rdquo; docs comes in two parts&ndash;One to install the Load Balancer and one to install the compilers.</em></strong></p>

<h3>First, Some Philosophy</h3>

<p>The Puppet Enterprise documentation circa PE 2015.3.2 had some &ldquo;issues&rdquo;. Let me actually preface that, though. Puppet Labs' documentation is by far some of the most voluminous and in many respects most complete vendor documentation out there. I don&rsquo;t mean to disparage their work AT ALL. When it comes to the fact they even have documentation at this level, they&rsquo;re the &ldquo;bees knees&rdquo;.</p>

<p>However, I&rsquo;ve always written documentation to fit the &ldquo;grandma rule&rdquo;. My grandmother was a little 4 foot nothing Cajun woman with English as her second language.  She never used the first computer, still had a rotary phone when she passed away, and remained suspicious of anything technical.  She <em>was</em>, however, a voracious reader, keenly intelligent, and understood considerably more than you&rsquo;d expect on first glance. She also was a stickler for puncutation, grammar, and the like. In short, if my grandma couldn&rsquo;t read the documentation and follow a step-by-step process to install Puppet successfully, then its just either too complex, poorly formatted or unclear and needs to be simplified.</p>

<p>This causes a problem, of course. There are technologists out there that would become annoyed at repetition, verbosity around &ldquo;understood&rdquo; things, and spelling out each and every step along the way&hellip; even painfully. However, I feel it is the only <em>proper</em> way to document something. My rules are simple.</p>

<ul>
<li>Leave nothing to question</li>
<li>Be as verbose and clear as possible</li>
<li>Make sure everything is in order, step-by-step</li>
</ul>


<p>By following this simple guideline, I feel I&rsquo;m doing more of a service to the reader than if I presumed on their level of sophistication with Puppet, Linux/UNIX, Windows, research capability, Google-foo or whatever.</p>

<p>So let&rsquo;s dive in, shall we?</p>

<h2>HAProxy</h2>

<p>Seemingly counterintuitive, now that we&rsquo;ve done a split install, I want to next install the HAProxy we will use as a Load Balancer on the additional compilers.  By installing this first, we can utilize Puppet to install the HAProxy, and manage them automatically rather than doing a lot of ad-hoc work.</p>

<p>Also, by doing the proxy first,  the prerequisites are satisfied in their proper order, the Load Balancer exists before configuring additional compilers (to be able to utilize the dns_alt_names for the load balancer along with the compilers) and to have the GitLab in place and hosting the control_repo before turning on and configuring Code Manager.</p>

<h3>Hardware</h3>

<p>In the initial hardware list, I included a node called &ldquo;Compile Master&rdquo;.  This node  looked like:</p>

<p><img src="http://cvquesty.github.io/images/compile_master_specs.png" alt="Compile Master Specs" /></p>

<p>This node may seem like overkill, but disk and memory are cheap.  If you are scaling at this level, its better to not have to reinstall your Load balancer later. Keep in mind, you don&rsquo;t have to use HAProxy and can use a corporate Load Balancer here, but its configuration is outside the scope of this tutorial.</p>

<p>Once you&rsquo;ve provisioned the load balancer, ssh to the node as the root user, and use the &ldquo;frictionless installer&rdquo; to add your Puppet agent.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -k https://master.example.com:8140/packages/current/install.bash | bash</span></code></pre></td></tr></table></div></figure>


<p>When the client is fully installed, retrieve the Enterprise Console from your browser, and navigate to Nodes | Classification | Unsigned Certificates and select &ldquo;Accept All&rdquo;.  Finally, ssh to the instance as the root user and run <strong><em>puppet agent -t</em></strong> to finish the setup.</p>

<h2>Configure the Load Balancer</h2>

<p>At this point, the node is provisioned and you have a Puppet agent running on it, but you have as of yet not configured the HAProxy Load Balancer for use in the environment. The load balancer will be necessary to have in place prior to adding compile masters to your existing split installation. The following instructions guide you through setting up the HAProxy load balancer.</p>

<ol>
<li><p>SSH to the Puppet Master as root.  <em>(<strong>master.example.com</strong> in our list)</em></p></li>
<li><p>Install the HAPRoxy Forge Module on the master</p></li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>puppet module install puppetlabs-haproxy</span></code></pre></td></tr></table></div></figure>


<p><br>
    <em>leave your root console open while performing steps 3-6</em></p>

<ol>
<li><p>Retrieve the Enterprise Console in your browser</p></li>
<li><p>Select <strong>Nodes</strong> | <strong>Classification</strong></p></li>
<li><p>Create a New Classification Group called &ldquo;<strong>Load Balancer</strong>&rdquo;</p></li>
<li><p>Select the new group from the list and pin the node &ldquo;<strong>compiler.example.com</strong>&rdquo; into the new group.</p></li>
<li><p>In your open SSH session to <strong>master.example.com</strong>, create the profiles module to hold the configuration for HAProxy</p></li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd /etc/puppetlabs/code/environments/production/modules
</span><span class='line'>
</span><span class='line'>mkdir -p profiles/manifests
</span><span class='line'>
</span><span class='line'>cd profiles/manifests</span></code></pre></td></tr></table></div></figure>


<ol>
<li><p>Once you have changed to the profiles/manifests directory, create the loadbalancer.pp manifest.</p></li>
<li><p>Follow the documentation <a href="https://forge.puppet.com/puppetlabs/haproxy/readme">here</a> to configure HAProxy. When complete, the loadbalancer.pp manifest should resemble the following with IPs corrected for your particular instance:</p></li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Load Balancer Profile
</span><span class='line'>class profiles::loadbalancer {
</span><span class='line'>
</span><span class='line'>  class { 'haproxy': }
</span><span class='line'>
</span><span class='line'>  # Main Proxy Listener
</span><span class='line'>  haproxy::listen { 'compiler.example.com':
</span><span class='line'>    collect_exported =&gt; false,
</span><span class='line'>    ipaddress        =&gt; $::ipaddress,
</span><span class='line'>    ports            =&gt; '8140',
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  # First Load balanced Compile Master
</span><span class='line'>  haproxy::balancermember { 'compiler1.example.com':
</span><span class='line'>    listening_service =&gt; 'compiler.example.com',
</span><span class='line'>    server_names      =&gt; 'compiler1.example.com',
</span><span class='line'>    ipaddress         =&gt; '10.0.1.24',
</span><span class='line'>    ports             =&gt; '8140',
</span><span class='line'>    options           =&gt; 'check',
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  # Second Load Balanced Compile Master
</span><span class='line'>  haproxy::balancermember { 'compiler2.example.com':
</span><span class='line'>    listening_service =&gt; 'compiler.example.com',
</span><span class='line'>    server_names      =&gt; 'compiler2.example.com',
</span><span class='line'>    ipaddress         =&gt; '10.0.1.25',
</span><span class='line'>    ports             =&gt; '8140',
</span><span class='line'>    options           =&gt; 'check',
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Once you have created this profile, retrieve the Puppet Enterprise Console in your browser and navigate to <strong>Nodes | Classification | Load Balancer</strong>.</p>

<ol>
<li>Selet the <strong>Classes</strong> tab.</li>
<li>Click the &ldquo;refresh&rdquo; button so the console will pick up your new loadbalancer.pp profile to classify your node with.</li>
<li>Under the &ldquo;Add new Class&rdquo; heading, select <strong>profiles::loadbalancer</strong> from the list that drops down.</li>
<li>Click &ldquo;Add Class&rdquo;.</li>
<li>Select &ldquo;Commit 1 Change&rdquo; at the bottom right of the page.</li>
<li>SSH back into <strong>compiler.example.com</strong> and run <strong>puppet agent -t</strong> to configure the Load Balancer.</li>
</ol>


<p>Your Load Balancer is now prepared to balance traffic to two catalog compilers (<em><strong>catalog1.example.com</strong> and <strong>catalog2.example.com</strong></em>) as listed in the above configuration.</p>

<h3>Notes</h3>

<hr />

<p>I noted when putting together the loadbalancer.pp profile above that I had previously used some REALLY ODD ip addresses in the balancer config.  Why? For the life of me I cannot recall. The original file looked like so:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Load Balancer Profile
</span><span class='line'>class profiles::loadbalancer {
</span><span class='line'>
</span><span class='line'>  class { 'haproxy': }
</span><span class='line'>
</span><span class='line'>  # Main Proxy Listener
</span><span class='line'>  haproxy::listen { 'compiler.example.com':
</span><span class='line'>    collect_exported =&gt; false,
</span><span class='line'>    ipaddress        =&gt; $::ipaddress,
</span><span class='line'>    ports            =&gt; '8140',
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  # First Load balanced Compile Master
</span><span class='line'>  haproxy::balancermember { 'compiler1.example.com':
</span><span class='line'>    listening_service =&gt; 'compiler.example.com',
</span><span class='line'>    server_names      =&gt; 'compiler1.example.com',
</span><span class='line'>    ipaddress         =&gt; '10.0.1.24',
</span><span class='line'>    ports             =&gt; '8140',
</span><span class='line'>    options           =&gt; 'check',
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  # Second Load Balanced Compile Master
</span><span class='line'>  haproxy::balancermember { 'compiler2.example.com':
</span><span class='line'>    listening_service =&gt; 'compiler.example.com',
</span><span class='line'>    server_names      =&gt; 'compiler2.example.com',
</span><span class='line'>    ipaddress         =&gt; '10.0.1.25',
</span><span class='line'>    ports             =&gt; '8140',
</span><span class='line'>    options           =&gt; 'check',
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>In my original implementation I set the ipaddres fields with some odd IP addresses. For info around how to fill those but ,the documentation gives some hints:</p>

<blockquote><p>ipaddresses: Optional. Specifies the IP address used to contact the balancermember service. Valid options: a string or an array. If you pass an array, it must contain the same number of elements as the array you pass to the server_names parameter. For each pair of entries in the ipaddresses and server_names arrays, Puppet creates server entries in haproxy.cfg targeting each port specified in the ports parameter. Default: the value of the $::ipaddress fact.</p></blockquote>

<p>Since I was originally setting these up in Digital Ocean, I used the IP space 159.203.x.x which belongs to Digital Ocean. I am guessing these were the hard IPs on the instances I stood up. Since the documentation above states these are optional, you have two options here.  Either leave those lines out of your config altogether, or manually set them to the IP Address of the instance you&rsquo;re using. Try each and do which works for you.</p>

<h2>Conclusion</h2>

<p>Your HAProxy Load balancer is now complete and ready to take traffic to the additional catalog compiler nodes. In installment IV, we&rsquo;ll begin to add in more components along the way to a fully developed LEI of Puppet Enterprise.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/04/18/scaling-puppet-enterprise-part-ii-installation/">Scaling Puppet Enterprise - Part II - Installation</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-04-18T13:03:21-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>1:03 pm</span></time>
        
           | <a href="/blog/2017/04/18/scaling-puppet-enterprise-part-ii-installation/#disqus_thread"
             data-disqus-identifier="http://questy.org/blog/2017/04/18/scaling-puppet-enterprise-part-ii-installation/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Installing Puppet Enterprise has been made remarkably easier as time has gone on. The efforts of Puppet Labs (I still can&rsquo;t get used to simply &lsquo;Puppet&rsquo;) to make the installation as seamless and powerful as possible with the simplest of interfaces has been highly successful.</p>

<p>Many changes have occurred over time to include changing from answer files to a <a href="https://docs.puppet.com/pe/latest/config_hocon.html">HOCON</a> formatted <strong>pe.conf</strong> file containing the various configuration elements you may need to stand up an instance. I somewhat preferred the simple nature of the original answer files, but I can see the sense in moving to HOCON moving forward.</p>

<p><strong>Obtain puppet</strong></p>

<p>Needless to say, you&rsquo;re going to need the Puppet Enterprise package to install from. Unlike Puppet Community, the entire installer is provided as a tarball rather than repo based installations via package management, and requires a little bit of UNIX-y knowhow to get it started, as the Puppet Enterprise Server is only installable on Linux.</p>

<p>When you navigate to the Puppet Download page, you may be required to sign up for a free account if you haven&rsquo;t already. The opening download page is found <a href="https://puppet.com/download-puppet-enterprise">here</a>.</p>

<p>You will be presented with a launch page that contains a &ldquo;Download&rdquo; button.  Click the button, and one of two things will happen.  Either you will be directed to a &ldquo;Thank You&rdquo; page or a page to sign up for an account. As you can see, the &ldquo;Thank You&rdquo; page means you already have an account and are signed in whereas the signup page is self-explanatory. Sign up for an account, and retry the download link.</p>

<p>Once you&rsquo;ve made it to the &ldquo;Thank You&rdquo; page, there are three tabs containing &ldquo;Puppet Enterprise Masters&rdquo;, &ldquo;Puppet Enterprise Agents&rdquo;, and &ldquo;Puppet Enterprise Client Tools&rdquo;. As of this writing, the only supported Puppet Master platforms are RedHat 6 &amp; 7, Ubuntu 12.04, 14.04, and 16.04, as well as SLES 11 and 12.</p>

<p>If you had intentions of running the Puppet Master server on any other platform, here is where you realign your expectations.  :)  I have heard that people have hacked the server to run on other platforms, but since we&rsquo;re dealing with Puppet Enterprise, why would you break support and eliminate warranty?  Pick one of the three and download the tarball for your appropriate platform.</p>

<p><strong><em>NOTE:  If You need legacy versions of PE, you can download those <a href="https://puppetlabs.com/misc/pe-files/previous-releases">here</a>.</em></strong></p>

<p><strong>Installation</strong></p>

<p>For the purposes of this scenario, we will be installing the Puppet Infrastructure for fictional super-mega huge company &ldquo;example.com&rdquo;. I am going to trust you have worked out the DNS/Host file naming structure, and can resolve everything everywhere.  If you cannot, don&rsquo;t comment on the post, as I will make fun of you publicly&hellip; you deserve it.</p>

<p>My assumed setup will be:</p>

<p><img src="http://cvquesty.github.io/images/node_list_example_com.png" alt="Example.com Node List" /></p>

<p><strong><em>Automated</em></strong></p>

<p>The Puppet Enterprise Installer is a GUI web-browser based installer. Puppet has gone through the process of giving you a nice frontend to your installation, and making it dead-easy to perform a monolithic as well as split installation.  For our purposes, though, we will be doing a &ldquo;split&rdquo; installation.</p>

<p><strong>Stand up 3 Nodes with the specifications from the first article in the series as follows:</strong></p>

<p><img src="http://cvquesty.github.io/images/split_node_list.png" alt="Split Node List" /></p>

<p>In my experience, I&rsquo;ve found it much easier to exchange root keys between all three of the above nodes to allow the installer to do all it needs to do on each node. You can, however, decide to set the root password to something temporary to hand to the installer as well (and many people opt for this) and then return root&rsquo;s password to your site default.  In any event, all the machines should be able to resolve themselves and each other by name and root should be able to freely ssh between them either via shared keys (easiest) or password.</p>

<p><strong>Transfer the package to the Puppet Master node:</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>scp -rp puppet-enterprise-2015.3.2-el-7-x86_64.tar.gz root@master.example.com:/root/</span></code></pre></td></tr></table></div></figure>


<p>Once the package is on the destination machine, you should connect to the machine to work with the package on-box:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ssh root@master.example.com</span></code></pre></td></tr></table></div></figure>


<p>which places you in the root user&rsquo;s home directory where you copied the package.</p>

<p><strong>Extract the Package</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tar -zxvf puppet-enterprise-2015.3.2-el-7-x86_64.tar.gz 
</span><span class='line'>cd puppet-enterprise-2015.3.2-el-7-x86_64</span></code></pre></td></tr></table></div></figure>


<p><strong>Run the Installer</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>./puppet-enterprise-installer</span></code></pre></td></tr></table></div></figure>


<p>You will receive a text prompt that states:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>??Install packages and guided install [Y,n]</span></code></pre></td></tr></table></div></figure>


<p>Simply press &ldquo;Y&rdquo; or the [Enter] key and the GUI portion of the installation will begin.</p>

<p><strong><em>GUI Installer</em></strong></p>

<p>Once you have started the Installation, the Puppet Enterprise Installer will perform some preparatory steps and then launch an installation interface on your master node on port 3000. To access this interface, you can bring it up in the web browser of your choice at:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://master.example.com:3000</span></code></pre></td></tr></table></div></figure>


<p>Navigate to this interface in your Internet browser. When you first arrive at the GUI installer, simply click the &ldquo;Let&rsquo;s Get Started&rdquo; button. On the next page, select &ldquo;Split&rdquo; to begin the Split Installation.The Puppet Enterprise Installer will present you with a GUI questionnaire to fill out regarding your environment. The following is that process in order by section.</p>

<h2>Puppet Master Component</h2>

<ol>
<li><p>Choose the &ldquo;Install on this Server&rdquo; radio button.2. Enter the name of your Master in the <strong>Puppet Master FQDN</strong> text box. (e.g. master.example.com) 3. Enter all appropriate names for your master in the <strong>Puppet Master DNS Aliases</strong> text box.4. Select the &ldquo;Enable Application orchestration&rdquo; check box.## PuppetDB Component</p></li>
<li><p>Enter the hostname of your PuppetDB Node in the <strong>PuppetDB Hostname</strong> text box. (e.g. puppetdb.example.com)</p></li>
<li>Change no other selections under the remainder of the items for this section.</li>
</ol>


<h2>PE Console Component</h2>

<ol>
<li>Enter the hostname of your Puppet Console in the Console Hostname text box. (e.g. console.example.com)</li>
<li>Change no other selections under the remainder of the items for this section.</li>
</ol>


<h3>Database Support</h3>

<p>No changes are needed to is section. Simply leave &ldquo;Install PostgreSQL on the PuppetDB host for me&rdquo; selected.</p>

<h3>Console &lsquo;admin&rsquo; User</h3>

<p>Enter the password you would like to use for the Puppet Enterprise console once your installation is complete in the final text box.</p>

<h2>Final Considerations</h2>

<p>After completing the final section, click the &ldquo;Submit&rdquo; button, and the Puppet Enterprise Installer will present you with a confirmation page for you to review before commencing the installation based on the configuration elements you just provided to the installer.</p>

<p>If everything is to your satisfaction, click the &ldquo;Continue&rdquo; button and the Puppet Enterprise Installation will begin.The Installation progress summary will continue to update you as to the progress of the installation. If you would like to see logging &ldquo;as it happens&rdquo;, you can click the &ldquo;log view&rdquo; button to see that in real time. If you would like to switch back to the summary, simply click the <strong>Summary</strong> button.After what is roughly 10-15 minutes of installation and configuration, the installer will have completed all its work, and you will be presented with a button at the bottom of the progress screen you have been viewing that says: &ldquo;Start Using Puppet Enterprise&rdquo;.  Click that button, and the installer will redirect you to the PE Console login screen.  Enter the admin credentials you created earlier, and you are ready to begin working with the console as needed.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/04/17/scaling-puppet-enterprise/">Scaling Puppet Enterprise</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-04-17T16:06:11-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>4:06 pm</span></time>
        
           | <a href="/blog/2017/04/17/scaling-puppet-enterprise/#disqus_thread"
             data-disqus-identifier="http://questy.org/blog/2017/04/17/scaling-puppet-enterprise/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In my former life as a consultant, I had to install all manner of configurations of Puppet for clients.  Some were small and some were large, but none were <strong><em>VERY</em></strong> large.  One of the big things I was finding back then was there just wasn&rsquo;t a lot of publicly available information regarding doing a full install and scaling it large.</p>

<p>So, I took some &ldquo;research time&rdquo; on my own and started to build out the configurations according to Puppet Labs' (at the time&hellip; now just &ldquo;Puppet&rdquo;) documentation. The problem I was having was that the docs wouldn&rsquo;t ever lead me to a successful install following a chronolgical set of steps. I had to click into subpages, jump over to sub-sub configurations, and then jump back to the main docs to follow yet another trail down until I reached the end&hellip;lather, rinse, repeat.</p>

<p><strong>Some Caveats..</strong></p>

<p><strong>First</strong>, this is probably no longer a good &ldquo;HOWTO&rdquo; unless you&rsquo;re installing an older Puppet Enterprise. It was created between 2015.2 and 2016.x, and likely has some amount of artifacting related to those versions.</p>

<p><strong>Second</strong>, I&rsquo;m going by docs I&rsquo;ve recorded for my own use.  I wrote these as mentioned above through prototyping, tearing it down, starting again, and literally doing the entire install over and over until it worked &ldquo;as advertised&rdquo;. A lot of this was really just ordering things the right way, and finding documentaiton for various pieces online at Puppet&rsquo;s documentation site as well as blogs, conversations, and plain old trial and error. I certainly can&rsquo;t warrant anything to anybody for any reason. As with most open source/creative commons assets, &ldquo;it works for me, hope it works for you, and if it doesn&rsquo;t, sorry about that.&rdquo;</p>

<p><strong>Finally</strong>, I hope to use this as the springboard to start brain-dumping all my old notes, conversations, ideas, and other prototyping I did in my home lab.  There&rsquo;s still a fair amount of documentation I cannot use or touch because they belong to my former employer or Puppet Labs, so some things may be less than clear and usually because I&rsquo;m dancing around an NDA, noncompete, or just plain being a nice guy. If I inadvertently reveal something I shouldn&rsquo;t, chances are it could disappear without a trace, but I&rsquo;ll still make a note that I removed something, and try and replace whatever it is with published docs.</p>

<p>In short: I want to help the community, but I&rsquo;m walking a tightrope here, so please be kind.</p>

<p><strong>Format</strong></p>

<p>I hope to start easy with a decision making process for installing Puppet, how to choose a method, think about scale, and will likely have quite an opinionated view at times.  Once PE is installed, we&rsquo;ll add compilers, scale postgres, etc. but for starters, I hope to just have the following:</p>

<p>PE Master (MoM)<br>
Puppet DB<br>
PE Console<br>
HA Proxy Node for Compilers<br>
Two Catalog Compilers<br>
One ActiveMQ Hub<br>
Two ActiveMQ Spokes<br>
Two Agent Nodes for testing<br></p>

<p>I know that&rsquo;s quite a number of nodes to get started with, but this after all a large environment infrastructure, and we want to scale big.</p>

<p><strong>Required Nodes</strong></p>

<p>To put together all the required components for a good large installation, I&rsquo;ve settled on the below specs. You can change those as you see fit, but note that some of the disk space requirements and related were due to Puppet&rsquo;s documented requirements <em>at the time</em>.  YMMV, of course, but this is what I consider to be a base level installation if you intend on scaling into the multiple tens of thousands of nodes. Be sure that if you&rsquo;re going to size this down that you&rsquo;re still meeting Puppet&rsquo;s needs in regards to memory, cores, and disk.  <em>(for a current listing of Puppet&rsquo;s reuqirements, you can look <a href="https://docs.puppet.com/pe/latest/sys_req_hw.html">here</a> for more information.)</em></p>

<p><img src="http://cvquesty.github.io/images/prerequisites.png" alt="Puppet_Prerequisites" /></p>

<p>In addition, you&rsquo;ll need to be aware of firewall requirements for such an installation.  Puppet has documentation regarding firewall configurations and needed ports at their website <a href="https://docs.puppet.com/pe/latest/sys_req_sysconfig.html#for-large-environment-installations">here</a>, but I&rsquo;ll insert the image and recount the requirements here.</p>

<p><img src="http://cvquesty.github.io/images/lei_port_diagram.png" alt="Firewall_Ports" /></p>

<p>In short:</p>

<p><img src="http://cvquesty.github.io/images/firewall_ports.png" alt="Firewall_Ports" /></p>

<p>This is a close approximation to what you need to know.  Detailed charts found in the above links, and a &ldquo;point-by-point&rdquo; port and use list is available to review.</p>

<p>In short, I&rsquo;ve found it easiest to have all PE components on the same VLAN with no restrictions between them. If you are going to have a local firewall turned up on each node, you&rsquo;ll need to manage all the above communications as you see fit, but for the serving infrastructure (if in a secure environment, of course) you can likely drop host firewalls in favor of corporate ones.  In short, make it as easy on yourself as you see fit while balancing that toward your corporate security policy.</p>

<p>Finally, make sure DNS and NTP are all ready to go.  I can&rsquo;t tell you the number of times I&rsquo;ve had major issues trying to get all this working, and NTP was off, or DNS didn&rsquo;t propagate as expected (it&rsquo;s always DNS, right?) or some other similar seemingly unrelated piece was not restarted or some such. Just make sure that all nodes resolve to their respective FQDN from all nodes. Obviously, the easiest way to do this is to simply put them all in DNS. You <strong><em>can</em></strong> manage the host files manually, but why would you want to do that?</p>

<p>If you&rsquo;re at this point and all ready to go, look to the next entry to get started.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/08/31/changes-are-afoot/">Changes Are Afoot</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-08-31T10:33:00-04:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2016</span></span> <span class='time'>10:33 am</span></time>
        
           | <a href="/blog/2016/08/31/changes-are-afoot/#disqus_thread"
             data-disqus-identifier="http://questy.org/blog/2016/08/31/changes-are-afoot/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>After much thought and consideration, I&rsquo;ve terminated my employ with ShadowSoft. I was travelling nearly every week all over the US, and not with my family as much as I&rsquo;d like. Unfortunately, this role was a 70% travel role, and our youngest needed Daddy home.</p>

<p><img src="http://cvquesty.github.io/images/paypal.png" alt="PayPal" /></p>

<p>As luck would have it, a totally awesome telecommute FT/Perm option came up with PayPal, and I accepted rather excitedly, and began that role today.  After some getting acquainted with my new duties, you should be seeing/hearing more from me on the Puppet front soon.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/06/13/travel-hiatus/">Travel Hiatus</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-06-13T10:06:29-04:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>10:06 am</span></time>
        
           | <a href="/blog/2016/06/13/travel-hiatus/#disqus_thread"
             data-disqus-identifier="http://questy.org/blog/2016/06/13/travel-hiatus/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>Out</strong></p>

<p>Just a quick update for you all. $work decided at some point that one of the things I was specifically hired for (blogging in the community) some sort of way &ldquo;gives away the farm&rdquo; in regards to Puppet, Puppet Consultation, and related items. As such, I&rsquo;ve been asked not to blog publicly regarding items we deliver as services.</p>

<p>:-(</p>

<p>It likely doesn&rsquo;t matter that much, as I&rsquo;m travelling more than I have in years, and am on-target to exceed 145k miles by Summer&rsquo;s end.  As a result, I will be laying off until I can regroup and find more time.</p>

<p>Sorry, but as they say &ldquo;them&rsquo;s the breaks&rdquo;.</p>

<p>If you need me, you can always find me on the Puppet community Slack Channel #puppet, and my nick there is @cvquesty.</p>

<p>Look for interesting news from me soon.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/10/02/some-housecleaning/">Some Housecleaning</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/04/28/scaling-puppet-enterprise-part-vi-code-manager/">Scaling Puppet Enterprise - Part VI - Code Manager</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/04/24/scaling-puppet-enterprise-part-v-gitlab/">Scaling Puppet Enterprise - Part v - GitLab</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/04/24/scaling-puppet-enterprise-part-iv-activemq-hub-and-spokes/">Scaling Puppet Enterprise - Part IV - ActiveMQ Hub and Spokes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/04/23/scaling-puppet-enterprise-part-iiib-additional-compilers/">Scaling Puppet Enterprise - Part IIIb - Additional Compilers</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/04/21/scaling-puppet-enterprise-part-iiia-additional-compilers/">Scaling Puppet Enterprise - Part IIIa - Additional Compilers</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/04/18/scaling-puppet-enterprise-part-ii-installation/">Scaling Puppet Enterprise - Part II - Installation</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/04/17/scaling-puppet-enterprise/">Scaling Puppet Enterprise</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/08/31/changes-are-afoot/">Changes Are Afoot</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/06/13/travel-hiatus/">Travel Hiatus</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/CVQuesty">@CVQuesty</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'CVQuesty',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





<section>
<div class="fb-like-box" data-href="http://www.facebook.com/jerald.sheets" data-width="260" data-show-faces="true" data-stream="true" data-header=""   ></div>
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Jerald Sheets -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'questy-org';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
